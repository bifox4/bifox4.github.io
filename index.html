<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AR Plante - WebXR</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            overflow: hidden;
        }
        
        #ar-button {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 24px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
            z-index: 100;
        }
        
        #ar-button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        
        #info {
            position: absolute;
            top: 10px;
            left: 10px;
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            padding: 10px;
            border-radius: 4px;
            z-index: 100;
        }
        
        #xr-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
    </style>
</head>
<body>
    <div id="info">
        Appuyez sur le bouton pour placer le marqueur virtuel
    </div>
    
    <button id="ar-button">Placer le marqueur</button>
    
    <canvas id="xr-canvas"></canvas>
    
    <script type="module">
        // Vérifier la compatibilité WebXR
        if (!navigator.xr) {
            document.getElementById('info').textContent = "WebXR n'est pas supporté par votre navigateur. Essayez avec Chrome ou Edge sur Android.";
            document.getElementById('ar-button').disabled = true;
        }
        
        // Variables globales
        let xrSession = null;
        let xrReferenceSpace = null;
        let markerPlaced = false;
        let markerTransform = null;
        
        // Éléments DOM
        const arButton = document.getElementById('ar-button');
        const canvas = document.getElementById('xr-canvas');
        const gl = canvas.getContext('webgl', { xrCompatible: true });
        
        // Initialiser Three.js (ou autre librairie 3D)
        // Pour cet exemple, nous allons utiliser des primitives WebGL simples
        
        // Fonction pour démarrer la session AR
        async function startXRSession() {
            try {
                // Demander une session AR
                const session = await navigator.xr.requestSession('immersive-ar', {
                    requiredFeatures: ['local', 'hit-test'],
                    optionalFeatures: ['dom-overlay'],
                    domOverlay: { root: document.body }
                });
                
                xrSession = session;
                arButton.textContent = "Placer le marqueur";
                markerPlaced = false;
                
                // Configurer le canvas WebGL pour WebXR
                await gl.makeXRCompatible();
                
                session.updateRenderState({
                    baseLayer: new XRWebGLLayer(session, gl)
                });
                
                // Obtenir l'espace de référence
                xrReferenceSpace = await session.requestReferenceSpace('local');
                
                // Démarrer la boucle de rendu
                session.requestAnimationFrame(onXRFrame);
                
                // Gérer la fin de session
                session.addEventListener('end', onXRSessionEnded);
                
            } catch (error) {
                console.error("Erreur lors du démarrage de la session AR:", error);
                document.getElementById('info').textContent = "Erreur: " + error.message;
            }
        }
        
        // Fonction appelée à chaque frame
        function onXRFrame(time, frame) {
            const session = frame.session;
            const referenceSpace = xrReferenceSpace;
            
            // Préparer le rendu
            const pose = frame.getViewerPose(referenceSpace);
            
            if (pose) {
                // Effacer le canvas
                gl.clearColor(0, 0, 0, 0);
                gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);
                
                // Rendu des vues (pour chaque œil en VR, une seule en AR)
                for (const view of pose.views) {
                    const viewport = session.renderState.baseLayer.getViewport(view);
                    gl.viewport(viewport.x, viewport.y, viewport.width, viewport.height);
                    
                    // Ici, nous pourrions ajouter le rendu 3D
                    // Pour cet exemple, nous gardons cela simple
                }
                
                // Si le marqueur a été placé, nous l'affichons
                if (markerPlaced && markerTransform) {
                    // Créer un espace temporaire pour la position du marqueur
                    const markerSpace = new XRRigidTransform(markerTransform.position, markerTransform.orientation);
                    const markerViewerSpace = referenceSpace.getOffsetReferenceSpace(markerSpace);
                    
                    // Obtenir la position du marqueur par rapport à la caméra
                    const markerPose = frame.getViewerPose(markerViewerSpace);
                    
                    if (markerPose) {
                        // Ici, nous pourrions dessiner notre marqueur 3D
                        // Pour cet exemple, nous allons simplement dessiner un carré rouge
                        // En pratique, vous utiliseriez Three.js ou autre pour un meilleur rendu
                        
                        // Dessiner un simple marqueur (carré rouge)
                        gl.viewport(0, 0, canvas.width, canvas.height);
                        
                        const projMatrix = markerPose.views[0].projectionMatrix;
                        const viewMatrix = markerPose.views[0].transform.inverse.matrix;
                        
                        // Dessiner le texte "Arroser cette plante" en 3D
                        // (Dans une vraie application, vous utiliseriez une librairie 3D pour cela)
                        
                        // Pour cet exemple, nous allons simplement afficher le texte dans l'info
                        document.getElementById('info').textContent = "Marqueur placé: Arroser cette plante";
                    }
                }
            }
            
            // Continuer la boucle de rendu
            session.requestAnimationFrame(onXRFrame);
        }
        
        // Fonction appelée lorsque la session AR se termine
        function onXRSessionEnded() {
            xrSession = null;
            arButton.textContent = "Démarrer AR";
            document.getElementById('info').textContent = "Session AR terminée. Appuyez sur le bouton pour recommencer.";
        }
        
        // Gestionnaire d'événement pour le bouton
        arButton.addEventListener('click', async () => {
            if (xrSession) {
                if (!markerPlaced) {
                    // Placer le marqueur à la position actuelle de l'appareil
                    const frame = await xrSession.requestAnimationFrame((time, frame) => {
                        const pose = frame.getViewerPose(xrReferenceSpace);
                        if (pose) {
                            markerTransform = {
                                position: { x: 0, y: 0, z: -1 }, // 1 mètre devant la caméra
                                orientation: { x: 0, y: 0, z: 0, w: 1 }
                            };
                            markerPlaced = true;
                            arButton.textContent = "Marqueur placé";
                        }
                    });
                }
            } else {
                await startXRSession();
            }
        });
        
        // Vérifier la disponibilité de WebXR AR
        async function checkXRSupport() {
            if (navigator.xr) {
                const supported = await navigator.xr.isSessionSupported('immersive-ar');
                if (!supported) {
                    document.getElementById('info').textContent = "AR n'est pas supporté sur votre appareil.";
                    arButton.disabled = true;
                }
            }
        }
        
        checkXRSupport();
    </script>
</body>
</html>
