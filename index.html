<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>AR Viewer - Ianis</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background: #000;
            font-family: Arial, sans-serif;
            touch-action: none;
        }
        #arView {
            position: absolute;
            width: 100%;
            height: 100%;
            display: none;
        }
        #startButton {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            padding: 15px 30px;
            background: #007AFF;
            color: white;
            border: none;
            border-radius: 30px;
            font-size: 18px;
            z-index: 100;
        }
        #status {
            position: absolute;
            top: 20px;
            left: 20px;
            color: white;
            background: rgba(0,0,0,0.7);
            padding: 10px;
            border-radius: 5px;
            z-index: 100;
        }
    </style>
</head>
<body>
    <div id="arView"></div>
    <div id="status">Prêt à démarrer l'AR</div>
    <button id="startButton">Activer la caméra AR</button>

    <!-- Three.js from CDN -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/loaders/GLTFLoader.js"></script>
    
    <script>
        // Variables globales
        let camera, scene, renderer;
        let model;
        let xrSession = null;

        // 1. Initialisation
        async function init() {
            // Créer la scène Three.js
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 0.1, 1000);
            
            // Configurer le renderer WebXR
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.xr.enabled = true;
            document.getElementById('arView').appendChild(renderer.domElement);

            // Charger le modèle
            try {
                const loader = new THREE.GLTFLoader();
                const gltf = await loader.loadAsync('/ianis.glb');
                model = gltf.scene;
                model.scale.set(0.5, 0.5, 0.5);
                model.visible = false;
                scene.add(model);
                updateStatus("Modèle chargé. Cliquez pour démarrer l'AR");
            } catch (error) {
                console.error("Erreur de chargement:", error);
                updateStatus("Erreur de chargement du modèle", true);
            }

            // Gestion du bouton
            document.getElementById('startButton').addEventListener('click', toggleAR);
            
            // Redimensionnement
            window.addEventListener('resize', onWindowResize);
        }

        // 2. Gestion AR
        async function toggleAR() {
            if (xrSession) {
                await endAR();
            } else {
                await startAR();
            }
        }

        async function startAR() {
            try {
                // Demande explicite d'accès à la caméra
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                stream.getTracks().forEach(track => track.stop());
                
                // Démarrer la session WebXR
                const session = await navigator.xr.requestSession('immersive-ar', {
                    requiredFeatures: ['local', 'hit-test'],
                    optionalFeatures: ['dom-overlay']
                });
                
                xrSession = session;
                renderer.xr.setSession(session);
                document.getElementById('arView').style.display = 'block';
                updateStatus("Recherche de surfaces...");
                
                // Configuration des événements
                session.addEventListener('end', endAR);
                renderer.setAnimationLoop(render);
                
                document.getElementById('startButton').textContent = "Quitter l'AR";
            } catch (error) {
                console.error("Erreur AR:", error);
                updateStatus("Erreur: " + error.message, true);
            }
        }

        function endAR() {
            if (xrSession) {
                xrSession.end();
            }
        }

        function cleanupAR() {
            document.getElementById('arView').style.display = 'none';
            xrSession = null;
            document.getElementById('startButton').textContent = "Activer la caméra AR";
            updateStatus("Session AR terminée");
            renderer.setAnimationLoop(null);
        }

        // 3. Rendering
        function render() {
            if (!renderer.xr.isPresenting) return;
            
            // Mettre à jour la position du modèle si nécessaire
            renderer.render(scene, camera);
        }

        // Utilitaires
        function updateStatus(message, isError = false) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.style.color = isError ? '#ff4444' : 'white';
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        // Démarrer l'application
        if (navigator.xr) {
            navigator.xr.isSessionSupported('immersive-ar')
                .then((supported) => {
                    if (supported) {
                        init();
                    } else {
                        updateStatus("AR non supporté sur cet appareil", true);
                    }
                });
        } else {
            updateStatus("WebXR non disponible. Utilisez Chrome/Edge sur Android ou Safari iOS 15+", true);
        }
    </script>
</body>
</html>
