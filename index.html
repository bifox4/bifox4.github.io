<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>AR Viewer - Ianis</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            font-family: Arial, sans-serif;
            background: #000;
            color: white;
        }
        #info {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0,0,0,0.8);
            padding: 10px;
            border-radius: 5px;
            font-size: 14px;
            z-index: 100;
        }
        #arButton {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 24px;
            background: #007AFF;
            color: white;
            border: none;
            border-radius: 30px;
            font-size: 16px;
            cursor: pointer;
            z-index: 100;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 18px;
        }
    </style>
</head>
<body>
    <div id="info">
        Déplacez votre appareil pour trouver une surface plane
    </div>
    <div id="loading">Chargement du modèle...</div>
    <button id="arButton">Activer la RA</button>

    <!-- Import Three.js -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/loaders/GLTFLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/webxr/ARButton.js"></script>

    <script>
        // Variables globales
        let model;
        let reticle;
        let anchorSet = false;

        // Initialisation
        async function init() {
            // 1. Créer la scène Three.js
            const scene = new THREE.Scene();
            const camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.01, 20);
            const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.xr.enabled = true;
            document.body.appendChild(renderer.domElement);

            // 2. Ajouter un éclairage
            const light = new THREE.AmbientLight(0xffffff, 1);
            scene.add(light);
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.5);
            directionalLight.position.set(0, 1, 0);
            scene.add(directionalLight);

            // 3. Créer un réticule pour le placement
            reticle = new THREE.Mesh(
                new THREE.RingGeometry(0.1, 0.2, 32).rotateX(-Math.PI / 2),
                new THREE.MeshBasicMaterial({ color: 0x00ff00 })
            );
            reticle.visible = false;
            scene.add(reticle);

            // 4. Charger le modèle GLB
            const loader = new THREE.GLTFLoader();
            try {
                const gltf = await loader.loadAsync('./ianis.glb');
                model = gltf.scene;
                model.scale.set(0.5, 0.5, 0.5);
                model.visible = false;
                scene.add(model);
                document.getElementById('loading').style.display = 'none';
            } catch (error) {
                console.error("Erreur de chargement:", error);
                document.getElementById('loading').textContent = "Erreur de chargement du modèle";
            }

            // 5. Configurer WebXR
            const arButton = ARButton.createButton(renderer, { 
                requiredFeatures: ['hit-test'],
                optionalFeatures: ['dom-overlay'],
                domOverlay: { root: document.body }
            });
            document.body.appendChild(arButton);

            // 6. Gestion des interactions
            const btn = document.getElementById('arButton');
            btn.addEventListener('click', () => {
                if (!anchorSet && model) {
                    model.position.copy(reticle.position);
                    model.visible = true;
                    anchorSet = true;
                    reticle.visible = false;
                    btn.textContent = "Réinitialiser";
                } else {
                    if (model) model.visible = false;
                    anchorSet = false;
                    btn.textContent = "Placer l'objet";
                }
            });

            // 7. Animation et détection des surfaces
            renderer.setAnimationLoop((timestamp, frame) => {
                if (frame) {
                    const referenceSpace = renderer.xr.getReferenceSpace();
                    const session = renderer.xr.getSession();
                    
                    if (session && !anchorSet) {
                        session.requestHitTestSource({ space: referenceSpace }).then((hitTestSource) => {
                            const hitTestResults = frame.getHitTestResults(hitTestSource);
                            if (hitTestResults.length > 0) {
                                const hit = hitTestResults[0];
                                reticle.visible = true;
                                reticle.position.setFromMatrixPosition(hit.getPose(referenceSpace).transform.matrix);
                            } else {
                                reticle.visible = false;
                            }
                        });
                    }
                }
                renderer.render(scene, camera);
            });

            // 8. Redimensionnement
            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            });
        }

        // Démarrer l'application
        init().catch((err) => {
            console.error("Erreur d'initialisation:", err);
            document.getElementById('loading').textContent = "Erreur : " + err.message;
        });
    </script>
</body>
</html>
